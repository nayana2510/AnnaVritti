<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ANNAVRITTI - From Seed to Market</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Maps API (Replace with your own key) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&callback=initMap" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', 'Nirmala UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9f0e9 100%);
            min-height: 100vh;
        }
        
        /* Language Bar */
        .language-bar {
            background: #1e4a2b;
            padding: 12px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .lang-btn {
            background: transparent;
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .lang-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .lang-btn.active {
            background: #ffd93d;
            color: #1e4a2b;
            border-color: #ffd93d;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1e4a2b 0%, #2d6a4f 100%);
            color: white;
            padding: 20px 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 42px;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .header h1 span {
            color: #ffd93d;
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.95;
        }
        
        .header .sub {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.8;
        }
        
        /* Voice Button */
        .voice-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-btn:hover {
            background: #ffd93d;
            color: #1e4a2b;
            transform: scale(1.1);
        }
        
        /* Rain Alert */
        .rain-alert {
            max-width: 1400px;
            margin: 10px auto;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            animation: slideDown 0.5s;
        }
        
        .rain-alert.red { 
            background: #fee2e2; 
            color: #991b1b; 
            border-left: 5px solid #dc2626; 
        }
        
        .rain-alert.yellow { 
            background: #fef9c3; 
            color: #854d0e; 
            border-left: 5px solid #eab308; 
        }
        
        .rain-alert.green { 
            background: #dcfce7; 
            color: #166534; 
            border-left: 5px solid #16a34a; 
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        /* Journey Roadmap */
        .roadmap {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            background: white;
            padding: 15px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            cursor: pointer;
            padding: 10px 5px;
            transition: all 0.3s;
            border-radius: 30px;
            min-width: 70px;
        }
        
        .step:hover {
            background: #f0f7f0;
        }
        
        .step.active {
            background: #1e4a2b;
            color: white;
        }
        
        .step-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .sidebar h3 {
            color: #1e4a2b;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .farm-input {
            margin-bottom: 15px;
        }
        
        .farm-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .farm-input input, .farm-input select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .farm-input input:focus, .farm-input select:focus {
            outline: none;
            border-color: #1e4a2b;
        }
        
        /* Location Status */
        .location-status {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 12px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        #locationText {
            color: #1e4a2b;
            font-weight: 500;
        }
        
        /* Map Container */
        #map {
            height: 250px;
            width: 100%;
            margin: 15px 0;
            border-radius: 15px;
            display: none;
            border: 2px solid #1e4a2b;
        }
        
        /* Main Panel */
        .main-panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stage-title {
            color: #1e4a2b;
            font-size: 26px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stage-title span {
            font-size: 32px;
        }
        
        .stage-desc {
            color: #666;
            margin-bottom: 25px;
            font-size: 16px;
        }
        
        /* Buttons */
        .btn {
            background: #1e4a2b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #12351e;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #ffd93d;
            color: #1e4a2b;
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
            display: inline-block;
            margin: 5px;
        }
        
        /* Result Box */
        .result-box {
            margin-top: 25px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 15px;
            border-left: 8px solid #1e4a2b;
            display: none;
        }
        
        .result-box.show {
            display: block;
        }
        
        .result-box h3 {
            color: #1e4a2b;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .card {
            background: #f8faf8;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #1e4a2b;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Companion Card */
        .companion-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #1e4a2b;
        }
        
        .companion-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            background: #f0f7f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bad-companion {
            border-left-color: #c53030;
            background: #fff5f5;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed #1e4a2b;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            background: #f8faf8;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #e8f5e9;
            transform: scale(1.02);
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 10px;
            display: none;
            border: 2px solid #1e4a2b;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f0f0f0;
            border-top: 5px solid #1e4a2b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, #1e4a2b, #2d6a4f);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
        }
        
        .weather-temp {
            font-size: 3rem;
            font-weight: 700;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Profit Highlight */
        .profit-highlight {
            background: #1e4a2b;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }
        
        /* Badge */
        .badge {
            background: #1e4a2b;
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 14px;
            display: inline-block;
            margin: 5px 0;
        }
        
        .badge-warning {
            background: #c53030;
        }
        
        /* Real Data Indicator */
        .real-data-badge {
            background: #0077be;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-left: 10px;
        }
        
        /* Chatbot */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #1e4a2b;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: transform 0.3s;
        }
        
        .chat-toggle:hover {
            transform: scale(1.1);
        }
        
        .chatbot {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: #1e4a2b;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .bot-message, .user-message {
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .bot-message {
            background: #e8f5e9;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .user-message {
            background: #1e4a2b;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background: white;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .chat-input button {
            background: #1e4a2b;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            color: white;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .roadmap {
                border-radius: 20px;
            }
            
            .language-bar {
                justify-content: center;
            }
            
            .header h1 {
                font-size: 32px;
            }
            
            .voice-btn {
                position: static;
                margin: 10px auto;
            }
            
            .chatbot {
                width: 300px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Language Bar -->
    <div class="language-bar">
        <button class="lang-btn active" onclick="changeLanguage('en')">üá¨üáß English</button>
        <button class="lang-btn" onclick="changeLanguage('ta')">üáÆüá≥ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
        <button class="lang-btn" onclick="changeLanguage('ml')">üáÆüá≥ ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</button>
        <button class="lang-btn" onclick="changeLanguage('te')">üáÆüá≥ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
    </div>

    <!-- Header -->
    <div class="header">
        <button class="voice-btn" onclick="speakWelcome()" id="voiceBtn">üîä</button>
        <h1>üåæ ANNA<span>VRITTI</span></h1>
        <p id="tagline">From Seed to Market</p>
        <div class="sub" id="subTagline">Your AI Farming Companion</div>
    </div>

    <!-- Rain Alert Banner -->
    <div id="rainAlert" class="rain-alert" style="display: none;"></div>

    <div class="container">
        <!-- Journey Roadmap -->
        <div class="roadmap" id="roadmap">
            <div class="step active" onclick="setStage(1)">
                <div class="step-icon">üå±</div>
                <div class="step-text" data-en="Seed" data-ta="‡Æµ‡Æø‡Æ§‡Øà" data-ml="‡¥µ‡¥ø‡¥§‡µç‡¥§‡µç" data-te="‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞®‡∞Ç">Seed</div>
            </div>
            <div class="step" onclick="setStage(2)">
                <div class="step-icon">ü™¥</div>
                <div class="step-text" data-en="Soil" data-ta="‡ÆÆ‡Æ£‡Øç" data-ml="‡¥Æ‡¥£‡µç‡¥£‡µç" data-te="‡∞Æ‡∞ü‡±ç‡∞ü‡∞ø">Soil</div>
            </div>
            <div class="step" onclick="setStage(3)">
                <div class="step-icon">üåø</div>
                <div class="step-text" data-en="Sow" data-ta="‡Æ®‡Æü‡Æµ‡ØÅ" data-ml="‡¥µ‡¥ø‡¥§‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µΩ" data-te="‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞°‡∞Ç">Sow</div>
            </div>
            <div class="step" onclick="setStage(4)">
                <div class="step-icon">üå§Ô∏è</div>
                <div class="step-text" data-en="Weather" data-ta="‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà" data-ml="‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥•" data-te="‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç">Weather</div>
            </div>
            <div class="step" onclick="setStage(5)">
                <div class="step-icon">üî¨</div>
                <div class="step-text" data-en="Protect" data-ta="‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ" data-ml="‡¥∏‡¥Ç‡¥∞‡¥ï‡µç‡¥∑‡¥£‡¥Ç" data-te="‡∞∞‡∞ï‡±ç‡∞∑‡∞£">Protect</div>
            </div>
            <div class="step" onclick="setStage(6)">
                <div class="step-icon">‚è∞</div>
                <div class="step-text" data-en="Harvest" data-ta="‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà" data-ml="‡¥µ‡¥ø‡¥≥‡¥µ‡µÜ‡¥ü‡µÅ‡¥™‡µç‡¥™‡µç" data-te="‡∞ï‡±ã‡∞§">Harvest</div>
            </div>
            <div class="step" onclick="setStage(7)">
                <div class="step-icon">üì¶</div>
                <div class="step-text" data-en="Store" data-ta="‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ" data-ml="‡¥∏‡¥Ç‡¥≠‡¥∞‡¥£‡¥Ç" data-te="‡∞®‡∞ø‡∞≤‡±ç‡∞µ">Store</div>
            </div>
            <div class="step" onclick="setStage(8)">
                <div class="step-icon">üí∞</div>
                <div class="step-text" data-en="Sell" data-ta="‡Æµ‡Æø‡Æ±‡Øç‡Æ™‡Æ©‡Øà" data-ml="‡¥µ‡¥ø‡µΩ‡¥™‡µç‡¥™‡¥®" data-te="‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞ï‡∞Ç">Sell</div>
            </div>
            <div class="step" onclick="setStage(9)">
                <div class="step-icon">üåæ</div>
                <div class="step-text" data-en="Intercrop" data-ta="‡Æá‡Æü‡Øà‡Æ™‡Øç‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç" data-ml="‡¥á‡¥ü‡¥µ‡¥ø‡¥≥" data-te="‡∞Ö‡∞Ç‡∞§‡∞∞ ‡∞™‡∞Ç‡∞ü">Intercrop</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Sidebar -->
            <div class="sidebar">
                <h3 id="farmDetailsTitle">üåæ Your Farm Details</h3>
                
                <div class="farm-input">
                    <label id="locationLabel">Location</label>
                    <select id="location" onchange="manualLocationChange()">
                        <option value="tn">Tamil Nadu</option>
                        <option value="kl">Kerala</option>
                        <option value="ap">Andhra Pradesh</option>
                        <option value="ts">Telangana</option>
                        <option value="ka">Karnataka</option>
                    </select>
                </div>
                
                <!-- GPS Location Status -->
                <div class="location-status" id="locationStatus">
                    <span id="locationText">üìç Click to detect location</span>
                    <button onclick="getUserLocation()" class="btn-small">üìç Get GPS</button>
                </div>
                
                <!-- Map Container -->
                <div id="map"></div>
                
                <!-- Map Toggle Button -->
                <button onclick="toggleMap()" class="btn btn-secondary" style="margin-bottom: 15px;">
                    üó∫Ô∏è Show Nearby Mandis
                </button>
                
                <div class="farm-input">
                    <label id="soilTypeLabel">Soil Type</label>
                    <select id="soilType">
                        <option value="loamy">Loamy (Best)</option>
                        <option value="clay">Clay</option>
                        <option value="sandy">Sandy</option>
                        <option value="black">Black Cotton</option>
                    </select>
                </div>
                
                <div class="farm-input">
                    <label id="farmSizeLabel">Farm Size (acres)</label>
                    <input type="number" id="farmSize" value="2.5" min="0.5" max="100" step="0.5">
                </div>
                
                <div class="farm-input">
                    <label id="seasonLabel">Season</label>
                    <select id="season">
                        <option value="kharif">Kharif (June-Oct)</option>
                        <option value="rabi">Rabi (Nov-March)</option>
                        <option value="zaid">Zaid (Summer)</option>
                    </select>
                </div>
                
                <button class="btn" onclick="updateAll()" id="updateBtn">üîÑ Update & Analyze</button>
                
                <!-- Blockchain & Compare Buttons -->
                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="viewBlockchain()">
                    üîó View Blockchain
                </button>
                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="viewTransactions()">
                    üìù View Transactions
                </button>
                <button class="btn" style="margin-top: 10px;" onclick="compareFarms()">
                    üìä Compare with Neighbors
                </button>
                
                <!-- Live Weather Preview -->
                <div class="weather-widget" id="sidebarWeather" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Loading weather...</span>
                    </div>
                </div>
            </div>

            <!-- Main Panel -->
            <div class="main-panel">
                <div id="stageContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">ANNAVRITTI is analyzing your farm with REAL-TIME data...</p>
                </div>
                
                <div class="result-box" id="resultBox">
                    <h3 id="resultTitle">‚ú® AI Recommendations</h3>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot" id="chatbot">
        <div class="chat-header">
            <span>ü§ñ Kisaan Mitra</span>
            <button onclick="toggleChatbot()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="bot-message">Namaste! I'm your AI farming assistant. Ask me about crops, weather, prices, or anything about farming!</div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask anything..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <button class="chat-toggle" onclick="toggleChatbot()">ü§ñ</button>

    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        
        let currentLang = 'en';
        let currentStage = 1;
        let currentLocation = { lat: 10.7905, lon: 78.7045 }; // Default Tamil Nadu
        let currentSoilPH = 6.5;
        let currentWeather = null;
        let map = null;
        let userMarker = null;
        
        // Soil pH mapping
        const soilPHMap = {
            'loamy': 6.5,
            'clay': 7.2,
            'sandy': 6.0,
            'black': 7.5
        };
        
        // ============================================
        // LANGUAGE FUNCTIONS
        // ============================================
        
        function changeLanguage(lang) {
            currentLang = lang;
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent.includes(
                    lang === 'en' ? 'English' : 
                    lang === 'ta' ? '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' :
                    lang === 'ml' ? '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç' : '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å'
                )) {
                    btn.classList.add('active');
                }
            });
            
            updateAllText();
            loadStage(currentStage);
        }
        
        function updateAllText() {
            // Update step texts
            document.querySelectorAll('.step-text').forEach(el => {
                el.textContent = el.getAttribute(`data-${currentLang}`);
            });
            
            // Update header
            const headers = {
                'en': { tagline: 'From Seed to Market', sub: 'Your AI Farming Companion' },
                'ta': { tagline: '‡Æµ‡Æø‡Æ§‡Øà‡ÆØ‡Æø‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æµ‡Æ∞‡Øà', sub: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç AI ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æ§‡ØÅ‡Æ£‡Øà' },
                'ml': { tagline: '‡¥µ‡¥ø‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥µ‡¥ø‡¥™‡¥£‡¥ø‡¥Ø‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç', sub: '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ AI ‡¥ï‡µÉ‡¥∑‡¥ø ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø' },
                'te': { tagline: '‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞®‡∞Ç ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞µ‡∞∞‡∞ï‡±Å', sub: '‡∞Æ‡±Ä AI ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡∞æ‡∞Ø ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å' }
            };
            
            document.getElementById('tagline').textContent = headers[currentLang].tagline;
            document.getElementById('subTagline').textContent = headers[currentLang].sub;
            
            // Update sidebar
            const sidebar = {
                'en': { title: 'üåæ Your Farm Details', location: 'Location', soil: 'Soil Type', size: 'Farm Size (acres)', season: 'Season', update: 'üîÑ Update & Analyze' },
                'ta': { title: 'üåæ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ£‡Øç‡Æ£‡Øà ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç', location: '‡Æá‡Æü‡ÆÆ‡Øç', soil: '‡ÆÆ‡Æ£‡Øç ‡Æµ‡Æï‡Øà', size: '‡Æ™‡Æ£‡Øç‡Æ£‡Øà ‡ÆÖ‡Æ≥‡Æµ‡ØÅ (‡Æè‡Æï‡Øç‡Æï‡Æ∞‡Øç)', season: '‡Æ™‡Æ∞‡ØÅ‡Æµ‡ÆÆ‡Øç', update: 'üîÑ ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç' },
                'ml': { title: 'üåæ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥´‡¥æ‡¥Ç ‡¥µ‡¥ø‡¥∂‡¥¶‡¥æ‡¥Ç‡¥∂‡¥ô‡µç‡¥ô‡µæ', location: '‡¥∏‡µç‡¥•‡¥≤‡¥Ç', soil: '‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡¥∞‡¥Ç', size: '‡¥´‡¥æ‡¥Ç ‡¥µ‡¥≤‡µÅ‡¥™‡µç‡¥™‡¥Ç (‡¥è‡¥ï‡µç‡¥ï‡µº)', season: '‡¥∏‡µÄ‡¥∏‡µ∫', update: 'üîÑ ‡¥Ö‡¥™‡µç‡¥°‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µç ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç' },
                'te': { title: 'üåæ ‡∞Æ‡±Ä ‡∞™‡±ä‡∞≤‡∞Ç ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å', location: '‡∞™‡±ç‡∞∞‡∞¶‡±á‡∞∂‡∞Ç', soil: '‡∞Æ‡∞ü‡±ç‡∞ü‡∞ø ‡∞∞‡∞ï‡∞Ç', size: '‡∞™‡±ä‡∞≤‡∞Ç ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç (‡∞é‡∞ï‡∞∞‡∞æ‡∞≤‡±Å)', season: '‡∞∏‡±Ä‡∞ú‡∞®‡±ç', update: 'üîÑ ‡∞Ö‡∞™‡±ç‡∞°‡±á‡∞ü‡±ç & ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£' }
            };
            
            document.getElementById('farmDetailsTitle').textContent = sidebar[currentLang].title;
            document.getElementById('locationLabel').textContent = sidebar[currentLang].location;
            document.getElementById('soilTypeLabel').textContent = sidebar[currentLang].soil;
            document.getElementById('farmSizeLabel').textContent = sidebar[currentLang].size;
            document.getElementById('seasonLabel').textContent = sidebar[currentLang].season;
            document.getElementById('updateBtn').innerHTML = sidebar[currentLang].update;
            document.getElementById('loadingText').innerHTML = 
                currentLang === 'en' ? 'ANNAVRITTI is analyzing your farm with REAL-TIME data...' :
                currentLang === 'ta' ? '‡ÆÖ‡Æ©‡Øç‡Æ©‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æø ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ£‡Øç‡Æ£‡Øà‡ÆØ‡Øà ‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æ®‡Øá‡Æ∞ ‡Æ§‡Æ∞‡Æµ‡ØÅ‡Æï‡Æ≥‡ØÅ‡Æü‡Æ©‡Øç ‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...' :
                currentLang === 'ml' ? '‡¥Ö‡¥®‡µç‡¥®‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥ø ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥´‡¥æ‡¥Æ‡¥ø‡¥®‡µÜ ‡¥§‡¥§‡µç‡¥∏‡¥Æ‡¥Ø ‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...' :
                '‡∞Ö‡∞®‡±ç‡∞®‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø ‡∞Æ‡±Ä ‡∞™‡±ä‡∞≤‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞ø‡∞ú-‡∞∏‡∞Æ‡∞Ø ‡∞°‡±á‡∞ü‡∞æ‡∞§‡±ã ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...';
        }
        
        // ============================================
        // VOICE FUNCTIONS
        // ============================================
        
        function speakWelcome() {
            if (!window.speechSynthesis) {
                alert('Voice not supported');
                return;
            }
            
            const messages = {
                'en': 'Welcome to Annavritti. Your farming companion from seed to market.',
                'ta': '‡ÆÖ‡Æ©‡Øç‡Æ©‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡Æï‡Øç‡Æï‡ØÅ ‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç. ‡Æµ‡Æø‡Æ§‡Øà‡ÆØ‡Æø‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æµ‡Æ∞‡Øà ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æ§‡ØÅ‡Æ£‡Øà.',
                'ml': '‡¥Ö‡¥®‡µç‡¥®‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥∏‡µç‡¥µ‡¥æ‡¥ó‡¥§‡¥Ç. ‡¥µ‡¥ø‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥µ‡¥ø‡¥™‡¥£‡¥ø‡¥Ø‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µÅ‡¥≥‡µç‡¥≥ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ï‡µÉ‡¥∑‡¥ø ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø.',
                'te': '‡∞Ö‡∞®‡±ç‡∞®‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø‡∞ï‡∞ø ‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç. ‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞®‡∞Ç ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞µ‡∞∞‡∞ï‡±Å ‡∞Æ‡±Ä ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡∞æ‡∞Ø ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å.'
            };
            
            const utterance = new SpeechSynthesisUtterance(messages[currentLang]);
            utterance.lang = currentLang === 'en' ? 'en-IN' : 
                           currentLang === 'ta' ? 'ta-IN' :
                           currentLang === 'ml' ? 'ml-IN' : 'te-IN';
            window.speechSynthesis.speak(utterance);
        }
        
        // ============================================
        // GPS & MAP FUNCTIONS
        // ============================================
        
        function getUserLocation() {
            document.getElementById('locationText').innerHTML = 'üìç Detecting your location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        currentLocation = { lat: lat, lon: lon };
                        
                        document.getElementById('locationText').innerHTML = 
                            `üìç Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        
                        if (map) {
                            map.setCenter({ lat: lat, lng: lon });
                            map.setZoom(14);
                            if (userMarker) {
                                userMarker.setMap(null);
                            }
                            userMarker = new google.maps.Marker({
                                position: { lat: lat, lng: lon },
                                map: map,
                                title: 'Your Farm',
                                icon: {
                                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                                }
                            });
                            
                            // Add nearby mandis
                            addNearbyMandis();
                        }
                        
                        fetchWeatherAndSoil();
                        showNotification('‚úÖ Location updated! Getting farm data...', 'success');
                    },
                    function(error) {
                        let errorMsg = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = "‚ùå Location access denied. Please enable location.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = "‚ùå Location unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMsg = "‚ùå Location request timed out.";
                                break;
                            default:
                                errorMsg = "‚ùå Unknown error.";
                        }
                        document.getElementById('locationText').innerHTML = errorMsg;
                        showNotification(errorMsg, 'error');
                    },
                    {enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                document.getElementById('locationText').innerHTML = "‚ùå Geolocation not supported";
                showNotification("‚ùå Your browser doesn't support location", 'error');
            }
        }
        
        function initMap() {
            const defaultLocation = { lat: currentLocation.lat, lng: currentLocation.lon };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 12,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });
            
            userMarker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                title: 'Your Farm',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                }
            });
            
            addNearbyMandis();
        }
        
        function addNearbyMandis() {
            if (!map) return;
            
            const mandis = [
                { name: 'Central Mandi', lat: currentLocation.lat + 0.02, lng: currentLocation.lon + 0.01, price: '‚Çπ35/kg', crops: 'Tomato, Onion' },
                { name: 'Vegetable Market', lat: currentLocation.lat - 0.01, lng: currentLocation.lon - 0.02, price: '‚Çπ34/kg', crops: 'Potato, Brinjal' },
                { name: 'Farmers Mandi', lat: currentLocation.lat + 0.01, lng: currentLocation.lon - 0.01, price: '‚Çπ36/kg', crops: 'Chili, Beans' },
                { name: 'Wholesale Market', lat: currentLocation.lat - 0.02, lng: currentLocation.lon + 0.02, price: '‚Çπ33/kg', crops: 'Rice, Wheat' }
            ];
            
            mandis.forEach(mandi => {
                const marker = new google.maps.Marker({
                    position: { lat: mandi.lat, lng: mandi.lng },
                    map: map,
                    title: mandi.name,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                    }
                });
                
                const infowindow = new google.maps.InfoWindow({
                    content: `<div style="padding: 10px;">
                        <h4 style="margin:0 0 5px 0; color: #1e4a2b;">${mandi.name}</h4>
                        <p style="margin:5px 0;"><strong>Price:</strong> ${mandi.price}</p>
                        <p style="margin:5px 0;"><strong>Crops:</strong> ${mandi.crops}</p>
                        <p style="margin:5px 0;"><strong>Distance:</strong> ~${(Math.random()*5+1).toFixed(1)} km</p>
                    </div>`
                });
                
                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });
            });
        }
        
        function toggleMap() {
            const mapDiv = document.getElementById('map');
            if (mapDiv.style.display === 'none' || mapDiv.style.display === '') {
                mapDiv.style.display = 'block';
                setTimeout(() => {
                    if (map) {
                        google.maps.event.trigger(map, 'resize');
                        map.setCenter({ lat: currentLocation.lat, lng: currentLocation.lon });
                    }
                }, 100);
            } else {
                mapDiv.style.display = 'none';
            }
        }
        
        function manualLocationChange() {
            const location = document.getElementById('location').value;
            const coords = {
                'tn': { lat: 10.7905, lon: 78.7045 },
                'kl': { lat: 10.8505, lon: 76.2711 },
                'ap': { lat: 16.5062, lon: 80.6480 },
                'ts': { lat: 17.3850, lon: 78.4867 },
                'ka': { lat: 12.9716, lon: 77.5946 }
            };
            currentLocation = coords[location];
            document.getElementById('locationText').innerHTML = `üìç Location: ${location.toUpperCase()}`;
            fetchWeatherAndSoil();
            
            if (map) {
                map.setCenter({ lat: currentLocation.lat, lng: currentLocation.lon });
                if (userMarker) {
                    userMarker.setMap(null);
                }
                userMarker = new google.maps.Marker({
                    position: { lat: currentLocation.lat, lng: currentLocation.lon },
                    map: map,
                    title: 'Your Farm',
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                    }
                });
            }
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification`;
            notification.style.background = type === 'success' ? '#4caf50' : '#f44336';
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // ============================================
        // REAL DATA FETCHING
        // ============================================
        
        async function fetchWeatherAndSoil() {
            showLoading();
            
            try {
                // Fetch weather
                const weatherRes = await fetch(`/api/weather?lat=${currentLocation.lat}&lon=${currentLocation.lon}`);
                const weatherData = await weatherRes.json();
                
                if (weatherData.success) {
                    currentWeather = weatherData;
                    
                    document.getElementById('sidebarWeather').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="weather-temp">${weatherData.current_temp}¬∞C</div>
                                <div>Wind: ${weatherData.current_wind} km/h</div>
                            </div>
                            <div style="text-align: right;">
                                <div>${weatherData.advice.substring(0, 30)}...</div>
                            </div>
                        </div>
                    `;
                }
                
                // Fetch soil
                const soilRes = await fetch(`/api/soil?lat=${currentLocation.lat}&lon=${currentLocation.lon}`);
                const soilData = await soilRes.json();
                
                if (soilData.success) {
                    currentSoilPH = soilData.ph;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
            
            hideLoading();
        }
        
        // ============================================
        // STAGE FUNCTIONS
        // ============================================
        
        function setStage(stage) {
            currentStage = stage;
            
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active');
                if (index + 1 === stage) step.classList.add('active');
            });
            
            loadStage(stage);
        }
        
        function loadStage(stage) {
            const content = document.getElementById('stageContent');
            document.getElementById('resultBox').classList.remove('show');
            
            switch(stage) {
                case 1:
                    content.innerHTML = getStage1HTML();
                    break;
                case 2:
                    content.innerHTML = getStage2HTML();
                    break;
                case 3:
                    content.innerHTML = getStage3HTML();
                    break;
                case 4:
                    content.innerHTML = getStage4HTML();
                    getRealWeather();
                    break;
                case 5:
                    content.innerHTML = getStage5HTML();
                    break;
                case 6:
                    content.innerHTML = getStage6HTML();
                    break;
                case 7:
                    content.innerHTML = getStage7HTML();
                    break;
                case 8:
                    content.innerHTML = getStage8HTML();
                    break;
                case 9:
                    content.innerHTML = getStage9HTML();
                    getIntercropping('tomato');
                    break;
            }
        }
        
        function getStage1HTML() {
            return `
                <div class="stage-title">
                    <span>üå±</span> ${currentLang === 'en' ? 'Crop Advisor' : 
                                         currentLang === 'ta' ? '‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æï‡Æ∞‡Øç' :
                                         currentLang === 'ml' ? '‡¥µ‡¥ø‡¥≥ ‡¥â‡¥™‡¥¶‡µá‡¥∂‡¥ï‡µª' :
                                         '‡∞™‡∞Ç‡∞ü ‡∞∏‡∞≤‡∞π‡∞æ‡∞¶‡∞æ‡∞∞‡±Å'}
                    <span class="real-data-badge">REAL-TIME AI</span>
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'AI-powered crop recommendations based on your GPS location, soil, and weather. Get profit estimates with current market prices.' :
                       currentLang === 'ta' ? '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç GPS ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡ÆÆ‡Øç, ‡ÆÆ‡Æ£‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà ‡ÆÜ‡Æï‡Æø‡ÆØ‡Æµ‡Æ±‡Øç‡Æ±‡Æø‡Æ©‡Øç ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç AI ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øç. ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æµ‡Æø‡Æ≤‡Øà‡ÆØ‡ØÅ‡Æü‡Æ©‡Øç ‡Æá‡Æ≤‡Ææ‡Æ™ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç.' :
                       currentLang === 'ml' ? '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ GPS ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Ç, ‡¥Æ‡¥£‡µç‡¥£‡µç, ‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥• ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ‡¥Ø‡µÜ ‡¥Ö‡¥ü‡¥ø‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Æ‡¥æ‡¥ï‡µç‡¥ï‡¥ø‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ AI ‡¥µ‡¥ø‡¥≥ ‡¥∂‡µÅ‡¥™‡¥æ‡µº‡¥∂‡¥ï‡µæ. ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥µ‡¥ø‡¥™‡¥£‡¥ø ‡¥µ‡¥ø‡¥≤ ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥≤‡¥æ‡¥≠‡¥Ç ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï.' :
                       '‡∞Æ‡±Ä GPS ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç, ‡∞®‡±á‡∞≤ ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞Ç‡∞ó‡∞æ AI ‡∞™‡∞Ç‡∞ü ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡±ç‡∞∏‡±Å‡∞≤‡±Å. ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞ß‡∞∞‡∞§‡±ã ‡∞≤‡∞æ‡∞≠ ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ‡∞≤‡±Å.'}
                </div>
                <button class="btn" onclick="getDynamicRecommendations()">
                    üå± ${currentLang === 'en' ? 'Get AI Recommendations' :
                         currentLang === 'ta' ? 'AI ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï' :
                         currentLang === 'ml' ? 'AI ‡¥∂‡µÅ‡¥™‡¥æ‡µº‡¥∂‡¥ï‡µæ ‡¥®‡µá‡¥ü‡µÅ‡¥ï' :
                         'AI ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡±ç‡∞∏‡±Å‡∞≤‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø'}
                </button>
            `;
        }
        
        function getStage2HTML() {
            return `
                <div class="stage-title">
                    <span>ü™¥</span> ${currentLang === 'en' ? 'Soil Doctor' :
                                         currentLang === 'ta' ? '‡ÆÆ‡Æ£‡Øç ‡ÆÆ‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æµ‡Æ∞‡Øç' :
                                         currentLang === 'ml' ? '‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥°‡µã‡¥ï‡µç‡¥ü‡µº' :
                                         '‡∞Æ‡∞ü‡±ç‡∞ü‡∞ø ‡∞°‡∞æ‡∞ï‡±ç‡∞ü‡∞∞‡±ç'}
                    <span class="real-data-badge">AI + IMAGE</span>
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Upload a photo of your soil or use GPS-based analysis. Get real pH, nutrients, and recommendations.' :
                       currentLang === 'ta' ? '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ£‡Øç‡Æ£‡Æø‡Æ©‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ GPS ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Ææ‡Æ© ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç. ‡Æâ‡Æ£‡Øç‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© pH, ‡Æä‡Æü‡Øç‡Æü‡Æö‡Øç‡Æö‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.' :
                       currentLang === 'ml' ? '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ GPS ‡¥Ö‡¥ü‡¥ø‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Æ‡¥æ‡¥ï‡µç‡¥ï‡¥ø‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï. ‡¥Ø‡¥•‡¥æ‡µº‡¥§‡µç‡¥• pH, ‡¥™‡µã‡¥∑‡¥ï‡¥ô‡µç‡¥ô‡µæ, ‡¥∂‡µÅ‡¥™‡¥æ‡µº‡¥∂‡¥ï‡µæ ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ ‡¥®‡µá‡¥ü‡µÅ‡¥ï.' :
                       '‡∞Æ‡±Ä ‡∞®‡±á‡∞≤ ‡∞´‡±ã‡∞ü‡±ã‡∞®‡±Å ‡∞Ö‡∞™‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø ‡∞≤‡±á‡∞¶‡∞æ GPS ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞ø‡∞§ ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£‡∞®‡±Å ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø. ‡∞®‡∞ø‡∞ú‡∞Æ‡±à‡∞® pH, ‡∞™‡±ã‡∞∑‡∞ï‡∞æ‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡±ç‡∞∏‡±Å‡∞≤‡∞®‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø.'}
                </div>
                
                <div class="upload-area" onclick="document.getElementById('soilImage').click()">
                    <input type="file" id="soilImage" accept="image/*" style="display: none;" onchange="previewSoilImage(this)">
                    <div style="font-size: 48px;">üì∏</div>
                    <p>${currentLang === 'en' ? 'Click to upload soil photo' :
                         currentLang === 'ta' ? '‡ÆÆ‡Æ£‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ± ‡Æï‡Æø‡Æ≥‡Æø‡Æï‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç' :
                         currentLang === 'ml' ? '‡¥Æ‡¥£‡µç‡¥£‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï' :
                         '‡∞Æ‡∞ü‡±ç‡∞ü‡∞ø ‡∞´‡±ã‡∞ü‡±ã‡∞®‡±Å ‡∞Ö‡∞™‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞ï‡±ç‡∞≤‡∞ø‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø'}</p>
                    <img id="imagePreview" src="#" alt="Soil preview">
                </div>
                
                <button class="btn" onclick="analyzeSoilImage()">
                    üîç ${currentLang === 'en' ? 'Analyze Soil' :
                         currentLang === 'ta' ? '‡ÆÆ‡Æ£‡Øç ‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç' :
                         currentLang === 'ml' ? '‡¥Æ‡¥£‡µç‡¥£‡µç ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç' :
                         '‡∞Æ‡∞ü‡±ç‡∞ü‡∞ø ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£'}
                </button>
            `;
        }
        
        function getStage3HTML() {
            return `
                <div class="stage-title">
                    <span>üåø</span> ${currentLang === 'en' ? 'Sowing Guide' :
                                         currentLang === 'ta' ? '‡Æ®‡Æü‡Æµ‡ØÅ ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø' :
                                         currentLang === 'ml' ? '‡¥µ‡¥ø‡¥§‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µΩ ‡¥ó‡µà‡¥°‡µç' :
                                         '‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞® ‡∞ó‡±à‡∞°‡±ç'}
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Best time and method for sowing based on your location and crop selection.' :
                       currentLang === 'ta' ? '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡ÆÆ‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡Æø‡Æ©‡Øç ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æ®‡Æü‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æµ‡Æ§‡Æ±‡Øç‡Æï‡Ææ‡Æ© ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æ±‡Øà.' :
                       currentLang === 'ml' ? '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥µ‡µÅ‡¥Ç ‡¥µ‡¥ø‡¥≥ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥™‡µç‡¥™‡µÅ‡¥Ç ‡¥Ö‡¥ü‡¥ø‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Æ‡¥æ‡¥ï‡µç‡¥ï‡¥ø ‡¥µ‡¥ø‡¥§‡¥Ø‡µç‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥è‡¥±‡µç‡¥±‡¥µ‡µÅ‡¥Ç ‡¥®‡¥≤‡µç‡¥≤ ‡¥∏‡¥Æ‡¥Ø‡¥µ‡µÅ‡¥Ç ‡¥∞‡µÄ‡¥§‡¥ø‡¥Ø‡µÅ‡¥Ç.' :
                       '‡∞Æ‡±Ä ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞™‡∞Ç‡∞ü ‡∞é‡∞Ç‡∞™‡∞ø‡∞ï ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞Ç‡∞ó‡∞æ ‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞â‡∞§‡±ç‡∞§‡∞Æ ‡∞∏‡∞Æ‡∞Ø‡∞Ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞™‡∞¶‡±ç‡∞ß‡∞§‡∞ø.'}
                </div>
                <button class="btn" onclick="getSowingAdvice()">
                    üå± ${currentLang === 'en' ? 'Get Sowing Guide' :
                         currentLang === 'ta' ? '‡Æ®‡Æü‡Æµ‡ØÅ ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï' :
                         currentLang === 'ml' ? '‡¥µ‡¥ø‡¥§‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µΩ ‡¥ó‡µà‡¥°‡µç ‡¥®‡µá‡¥ü‡µÅ‡¥ï' :
                         '‡∞µ‡∞ø‡∞§‡±ç‡∞§‡∞® ‡∞ó‡±à‡∞°‡±ç ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø'}
                </button>
            `;
        }
        
        function getStage4HTML() {
            return `
                <div class="stage-title">
                    <span>üå§Ô∏è</span> ${currentLang === 'en' ? 'Weather Forecast' :
                                         currentLang === 'ta' ? '‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ' :
                                         currentLang === 'ml' ? '‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥• ‡¥™‡µç‡¥∞‡¥µ‡¥ö‡¥®‡¥Ç' :
                                         '‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£ ‡∞∏‡±Ç‡∞ö‡∞®'}
                    <span class="real-data-badge">LIVE</span>
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Real-time weather data for your exact GPS location from Open-Meteo.' :
                       currentLang === 'ta' ? '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡ØÅ‡Æ≤‡Øç‡Æ≤‡Æø‡ÆØ‡ÆÆ‡Ææ‡Æ© GPS ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡Ææ‡Æ© Open-Meteo ‡Æá‡Æ≤‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æ®‡Øá‡Æ∞ ‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà ‡Æ§‡Æ∞‡Æµ‡ØÅ.' :
                       currentLang === 'ml' ? '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ï‡µÉ‡¥§‡µç‡¥Ø‡¥Æ‡¥æ‡¥Ø GPS ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥§‡µç‡¥§‡¥ø‡¥®‡¥æ‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ Open-Meteo-‡¥Ø‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥§‡¥§‡µç‡¥∏‡¥Æ‡¥Ø ‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥• ‡¥°‡¥æ‡¥±‡µç‡¥±.' :
                       '‡∞Æ‡±Ä ‡∞ñ‡∞ö‡±ç‡∞ö‡∞ø‡∞§‡∞Æ‡±à‡∞® GPS ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç Open-Meteo ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞®‡∞ø‡∞ú-‡∞∏‡∞Æ‡∞Ø ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£ ‡∞°‡±á‡∞ü‡∞æ.'}
                </div>
                <div id="weatherContent"></div>
            `;
        }
        
        function getStage5HTML() {
            return `
                <div class="stage-title">
                    <span>üî¨</span> ${currentLang === 'en' ? 'Crop Doctor' :
                                         currentLang === 'ta' ? '‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡ÆÆ‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æµ‡Æ∞‡Øç' :
                                         currentLang === 'ml' ? '‡¥µ‡¥ø‡¥≥ ‡¥°‡µã‡¥ï‡µç‡¥ü‡µº' :
                                         '‡∞™‡∞Ç‡∞ü ‡∞°‡∞æ‡∞ï‡±ç‡∞ü‡∞∞‡±ç'}
                    <span class="real-data-badge">AI CAMERA</span>
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Use your camera to detect diseases early. Get instant treatment recommendations.' :
                       currentLang === 'ta' ? '‡Æ®‡Øã‡ÆØ‡Øç‡Æï‡Æ≥‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æï‡ØÇ‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Øá ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡ÆØ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡ÆÆ‡Æ∞‡Ææ‡Æµ‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç. ‡Æâ‡Æü‡Æ©‡Æü‡Æø ‡Æö‡Æø‡Æï‡Æø‡Æö‡Øç‡Æö‡Øà ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.' :
                       currentLang === 'ml' ? '‡¥∞‡µã‡¥ó‡¥ô‡µç‡¥ô‡µæ ‡¥®‡µá‡¥∞‡¥§‡µç‡¥§‡µá ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡¥æ‡µª ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï. ‡¥â‡¥ü‡¥®‡¥ü‡¥ø ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏‡¥æ ‡¥∂‡µÅ‡¥™‡¥æ‡µº‡¥∂‡¥ï‡µæ ‡¥®‡µá‡¥ü‡µÅ‡¥ï.' :
                       '‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡±Å‡∞≤‡∞®‡±Å ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å‡∞ó‡∞æ‡∞®‡±á ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Æ‡±Ä ‡∞ï‡±Ü‡∞Æ‡±Ü‡∞∞‡∞æ‡∞®‡±Å ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø. ‡∞§‡∞ï‡±ç‡∞∑‡∞£ ‡∞ö‡∞ø‡∞ï‡∞ø‡∞§‡±ç‡∞∏ ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡±ç‡∞∏‡±Å‡∞≤‡∞®‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø.'}
                </div>
                
                <div style="margin-top: 20px;">
                    <video id="video" width="100%" height="auto" autoplay style="border-radius: 15px; border: 3px solid #1e4a2b; display: none;"></video>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-small" onclick="startCamera()">üì∏ Start Camera</button>
                        <button class="btn btn-small" onclick="captureImage()">üîç Analyze</button>
                        <button class="btn btn-small" onclick="stopCamera()">‚èπÔ∏è Stop Camera</button>
                    </div>
                </div>
            `;
        }
        
        function getStage6HTML() {
            return `
                <div class="stage-title">
                    <span>‚è∞</span> ${currentLang === 'en' ? 'Harvest Assistant' :
                                         currentLang === 'ta' ? '‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç' :
                                         currentLang === 'ml' ? '‡¥µ‡¥ø‡¥≥‡¥µ‡µÜ‡¥ü‡µÅ‡¥™‡µç‡¥™‡µç ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø' :
                                         '‡∞ï‡±ã‡∞§ ‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å'}
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Know exactly when to harvest for best yield based on your planting date.' :
                       currentLang === 'ta' ? '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ®‡Æü‡Æµ‡ØÅ ‡Æ§‡Øá‡Æ§‡Æø‡ÆØ‡Æø‡Æ©‡Øç ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡ÆÆ‡Æï‡Æö‡ØÇ‡Æ≤‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Øà ‡ÆÖ‡Æ±‡Æø‡Æï.' :
                       currentLang === 'ml' ? '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥®‡¥ü‡µÄ‡µΩ ‡¥§‡µÄ‡¥Ø‡¥§‡¥ø‡¥Ø‡µÜ ‡¥Ö‡¥ü‡¥ø‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Æ‡¥æ‡¥ï‡µç‡¥ï‡¥ø ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥µ‡¥ø‡¥≥‡¥µ‡¥ø‡¥®‡µç ‡¥é‡¥™‡µç‡¥™‡µã‡µæ ‡¥µ‡¥ø‡¥≥‡¥µ‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡¥£‡¥Æ‡µÜ‡¥®‡µç‡¥®‡µç ‡¥Ö‡¥±‡¥ø‡¥Ø‡µÅ‡¥ï.' :
                       '‡∞Æ‡±Ä ‡∞®‡∞æ‡∞ü‡∞°‡∞Ç ‡∞§‡±á‡∞¶‡±Ä ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞Ç‡∞ó‡∞æ ‡∞â‡∞§‡±ç‡∞§‡∞Æ ‡∞¶‡∞ø‡∞ó‡±Å‡∞¨‡∞°‡∞ø‡∞ï‡∞ø ‡∞é‡∞™‡±ç‡∞™‡±Å‡∞°‡±Å ‡∞ï‡±ã‡∞Ø‡∞æ‡∞≤‡±ã ‡∞ñ‡∞ö‡±ç‡∞ö‡∞ø‡∞§‡∞Ç‡∞ó‡∞æ ‡∞§‡±Ü‡∞≤‡±Å‡∞∏‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø.'}
                </div>
                <button class="btn" onclick="getHarvestTime()">
                    ‚è∞ ${currentLang === 'en' ? 'Check Harvest Time' :
                         currentLang === 'ta' ? '‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï' :
                         currentLang === 'ml' ? '‡¥µ‡¥ø‡¥≥‡¥µ‡µÜ‡¥ü‡µÅ‡¥™‡µç‡¥™‡µç ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï' :
                         '‡∞ï‡±ã‡∞§ ‡∞∏‡∞Æ‡∞Ø‡∞Ç ‡∞§‡∞®‡∞ø‡∞ñ‡±Ä ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø'}
                </button>
            `;
        }
        
        function getStage7HTML() {
            return `
                <div class="stage-title">
                    <span>üì¶</span> ${currentLang === 'en' ? 'Storage Advisor' :
                                         currentLang === 'ta' ? '‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æï‡Æ∞‡Øç' :
                                         currentLang === 'ml' ? '‡¥∏‡¥Ç‡¥≠‡¥∞‡¥£ ‡¥â‡¥™‡¥¶‡µá‡¥∂‡¥ï‡µª' :
                                         '‡∞®‡∞ø‡∞≤‡±ç‡∞µ ‡∞∏‡∞≤‡∞π‡∞æ‡∞¶‡∞æ‡∞∞‡±Å'}
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Best storage methods to reduce post-harvest losses based on your crop.' :
                       currentLang === 'ta' ? '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ÆØ‡Æø‡Æ∞‡Æø‡Æ©‡Øç ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡Æ™‡Øç ‡Æ™‡Æø‡Æ®‡Øç‡Æ§‡Øà‡ÆØ ‡Æá‡Æ¥‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡ØÅ‡Æ±‡Øà‡Æï‡Øç‡Æï ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÆ‡ØÅ‡Æ±‡Øà‡Æï‡Æ≥‡Øç.' :
                       currentLang === 'ml' ? '‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥µ‡¥ø‡¥≥‡¥Ø‡µÜ ‡¥Ö‡¥ü‡¥ø‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Æ‡¥æ‡¥ï‡µç‡¥ï‡¥ø ‡¥µ‡¥ø‡¥≥‡¥µ‡µÜ‡¥ü‡µÅ‡¥™‡µç‡¥™‡¥ø‡¥®‡µç ‡¥∂‡µá‡¥∑‡¥Æ‡µÅ‡¥≥‡µç‡¥≥ ‡¥®‡¥∑‡µç‡¥ü‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÅ‡¥±‡¥Ø‡µç‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥∏‡¥Ç‡¥≠‡¥∞‡¥£ ‡¥∞‡µÄ‡¥§‡¥ø‡¥ï‡µæ.' :
                       '‡∞Æ‡±Ä ‡∞™‡∞Ç‡∞ü ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞Ç‡∞ó‡∞æ ‡∞™‡∞Ç‡∞ü‡∞ï‡±ã‡∞§ ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞®‡∞∑‡±ç‡∞ü‡∞æ‡∞≤‡∞®‡±Å ‡∞§‡∞ó‡±ç‡∞ó‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞â‡∞§‡±ç‡∞§‡∞Æ ‡∞®‡∞ø‡∞≤‡±ç‡∞µ ‡∞™‡∞¶‡±ç‡∞ß‡∞§‡±Å‡∞≤‡±Å.'}
                </div>
                <button class="btn" onclick="getStorageAdvice()">
                    üì¶ ${currentLang === 'en' ? 'Get Storage Advice' :
                         currentLang === 'ta' ? '‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï' :
                         currentLang === 'ml' ? '‡¥∏‡¥Ç‡¥≠‡¥∞‡¥£ ‡¥â‡¥™‡¥¶‡µá‡¥∂‡¥Ç ‡¥®‡µá‡¥ü‡µÅ‡¥ï' :
                         '‡∞®‡∞ø‡∞≤‡±ç‡∞µ ‡∞∏‡∞≤‡∞π‡∞æ ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø'}
                </button>
            `;
        }
        
        function getStage8HTML() {
            return `
                <div class="stage-title">
                    <span>üí∞</span> ${currentLang === 'en' ? 'Market Guru' :
                                         currentLang === 'ta' ? '‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æï‡ØÅ‡Æ∞‡ØÅ' :
                                         currentLang === 'ml' ? '‡¥Æ‡¥æ‡µº‡¥ï‡µç‡¥ï‡¥±‡µç‡¥±‡µç ‡¥ó‡µÅ‡¥∞‡µÅ' :
                                         '‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞ó‡±Å‡∞∞‡±Å‡∞µ‡±Å'}
                    <span class="real-data-badge">LIVE</span>
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Real-time market prices from nearby mandis. Know when to sell for maximum profit.' :
                       currentLang === 'ta' ? '‡ÆÖ‡Æ∞‡ØÅ‡Æï‡Æø‡Æ≤‡ØÅ‡Æ≥‡Øç‡Æ≥ ‡ÆÆ‡Æ£‡Øç‡Æü‡Æø‡Æï‡Æ≥‡Æø‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ®‡Æø‡Æï‡Æ¥‡Øç‡Æ®‡Øá‡Æ∞ ‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øç. ‡ÆÖ‡Æ§‡Æø‡Æï‡Æ™‡Æü‡Øç‡Æö ‡Æá‡Æ≤‡Ææ‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æµ‡Æø‡Æ±‡Øç‡Æï ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Øà ‡ÆÖ‡Æ±‡Æø‡Æï.' :
                       currentLang === 'ml' ? '‡¥∏‡¥Æ‡µÄ‡¥™‡¥§‡µç‡¥§‡µÜ ‡¥Æ‡¥£‡µç‡¥ü‡¥ø‡¥ï‡¥≥‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥§‡¥§‡µç‡¥∏‡¥Æ‡¥Ø ‡¥µ‡¥ø‡¥™‡¥£‡¥ø ‡¥µ‡¥ø‡¥≤‡¥ï‡µæ. ‡¥™‡¥∞‡¥Æ‡¥æ‡¥µ‡¥ß‡¥ø ‡¥≤‡¥æ‡¥≠‡¥§‡µç‡¥§‡¥ø‡¥®‡µç ‡¥é‡¥™‡µç‡¥™‡µã‡µæ ‡¥µ‡¥ø‡µΩ‡¥ï‡µç‡¥ï‡¥£‡¥Æ‡µÜ‡¥®‡µç‡¥®‡µç ‡¥Ö‡¥±‡¥ø‡¥Ø‡µÅ‡¥ï.' :
                       '‡∞∏‡∞Æ‡±Ä‡∞™ ‡∞Æ‡∞Ç‡∞°‡±Ä‡∞≤ ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞®‡∞ø‡∞ú-‡∞∏‡∞Æ‡∞Ø ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞ß‡∞∞‡∞≤‡±Å. ‡∞ó‡∞∞‡∞ø‡∞∑‡±ç‡∞ü ‡∞≤‡∞æ‡∞≠‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞é‡∞™‡±ç‡∞™‡±Å‡∞°‡±Å ‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞≤‡±ã ‡∞§‡±Ü‡∞≤‡±Å‡∞∏‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø.'}
                </div>
                
                <div class="farm-input">
                    <label>${currentLang === 'en' ? 'Select Crop' :
                               currentLang === 'ta' ? '‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ' :
                               currentLang === 'ml' ? '‡¥µ‡¥ø‡¥≥ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï' :
                               '‡∞™‡∞Ç‡∞ü ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø'}</label>
                    <select id="marketCrop" onchange="getMarketPrices()">
                        <option value="tomato">üçÖ Tomato</option>
                        <option value="onion">üßÖ Onion</option>
                        <option value="brinjal">üçÜ Brinjal</option>
                        <option value="chili">üå∂Ô∏è Chili</option>
                        <option value="potato">ü•î Potato</option>
                        <option value="carrot">ü•ï Carrot</option>
                        <option value="beans">ü´ò Beans</option>
                    </select>
                </div>
                
                <div id="marketContent"></div>
            `;
        }
        
        function getStage9HTML() {
            return `
                <div class="stage-title">
                    <span>üåæ</span> ${currentLang === 'en' ? 'Intercropping Guide' :
                                         currentLang === 'ta' ? '‡Æá‡Æü‡Øà‡Æ™‡Øç‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø' :
                                         currentLang === 'ml' ? '‡¥á‡¥ü‡¥µ‡¥ø‡¥≥ ‡¥ó‡µà‡¥°‡µç' :
                                         '‡∞Ö‡∞Ç‡∞§‡∞∞ ‡∞™‡∞Ç‡∞ü ‡∞ó‡±à‡∞°‡±ç'}
                    <span class="real-data-badge">SMART</span>
                </div>
                <div class="stage-desc">
                    ${currentLang === 'en' ? 'Discover which crops grow best together for maximum yield based on scientific research.' :
                       currentLang === 'ta' ? '‡ÆÖ‡Æ§‡Æø‡Æï ‡ÆÆ‡Æï‡Æö‡ØÇ‡Æ≤‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æ®‡Øç‡Æ§ ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç‡Æï‡Æ≥‡Øç ‡Æí‡Æ©‡Øç‡Æ±‡Ææ‡Æï ‡Æµ‡Æ≥‡Æ∞‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.' :
                       currentLang === 'ml' ? '‡¥™‡¥∞‡¥Æ‡¥æ‡¥µ‡¥ß‡¥ø ‡¥µ‡¥ø‡¥≥‡¥µ‡¥ø‡¥®‡µç ‡¥è‡¥§‡µä‡¥ï‡µç‡¥ï‡µÜ ‡¥µ‡¥ø‡¥≥‡¥ï‡µæ ‡¥í‡¥∞‡µÅ‡¥Æ‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥µ‡¥≥‡¥∞‡µÅ‡¥Æ‡µÜ‡¥®‡µç‡¥®‡µç ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡µÅ‡¥ï.' :
                       '‡∞ó‡∞∞‡∞ø‡∞∑‡±ç‡∞ü ‡∞¶‡∞ø‡∞ó‡±Å‡∞¨‡∞°‡∞ø ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞è ‡∞™‡∞Ç‡∞ü‡∞≤‡±Å ‡∞ï‡∞≤‡∞ø‡∞∏‡∞ø ‡∞™‡±Ü‡∞∞‡±Å‡∞ó‡±Å‡∞§‡∞æ‡∞Ø‡±ã ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞Ç‡∞°‡∞ø.'}
                </div>
                
                <div class="farm-input">
                    <label>${currentLang === 'en' ? 'Select Main Crop' :
                               currentLang === 'ta' ? '‡ÆÆ‡ØÅ‡Æï‡Øç‡Æï‡Æø‡ÆØ ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç' :
                               currentLang === 'ml' ? '‡¥™‡µç‡¥∞‡¥ß‡¥æ‡¥® ‡¥µ‡¥ø‡¥≥ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï' :
                               '‡∞™‡±ç‡∞∞‡∞ß‡∞æ‡∞® ‡∞™‡∞Ç‡∞ü‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø'}</label>
                    <select id="mainCrop" onchange="getIntercropping(this.value)">
                        <option value="tomato">üçÖ Tomato</option>
                        <option value="onion">üßÖ Onion</option>
                        <option value="brinjal">üçÜ Brinjal</option>
                        <option value="chili">üå∂Ô∏è Chili</option>
                        <option value="potato">ü•î Potato</option>
                        <option value="carrot">ü•ï Carrot</option>
                        <option value="beans">ü´ò Beans</option>
                    </select>
                </div>
                
                <div id="intercropContent"></div>
            `;
        }
        
        // ============================================
        // API CALLS
        // ============================================
        
        async function getDynamicRecommendations() {
            showLoading();
            
            try {
                const response = await fetch(`/api/recommend-crops?lat=${currentLocation.lat}&lon=${currentLocation.lon}&ph=${currentSoilPH}&season=${document.getElementById('season').value}`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<div class="cards-grid">';
                    
                    data.recommendations.forEach(crop => {
                        const name = crop[`name_${currentLang}`] || crop.name;
                        
                        html += `
                            <div class="card">
                                <div style="font-size: 48px; text-align: center;">${crop.icon}</div>
                                <h4 style="text-align: center; margin: 10px 0;">${name}</h4>
                                <div style="text-align: center;">
                                    <span class="badge">${crop.match_score}% Match</span>
                                </div>
                                <div style="margin-top: 15px;">
                                    <p><strong>üìÖ Harvest:</strong> ${crop.days_to_harvest} days</p>
                                    <p><strong>üí∞ Current Price:</strong> ${crop.current_price}</p>
                                    <p><strong>üìä Profit/Acre:</strong> ${crop.profit_per_acre}</p>
                                    <p><strong>üåæ Yield:</strong> ${crop.expected_yield}</p>
                                </div>
                                <div class="profit-highlight">‚≠ê ${crop.advice}
                                </div>
                                <button class="btn-small" style="margin-top: 10px; width: 100%;" onclick="selectCrop('${crop.id}')">
                                    Select Crop
                                </button>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    // Add profit chart
                    html += `
                        <div style="margin-top: 30px;">
                            <h3 style="color: #1e4a2b;">üìà 5-Year Profit Projection</h3>
                            <canvas id="profitChart" style="margin-top: 20px;"></canvas>
                        </div>
                    `;
                    
                    showResult('üå± AI Crop Recommendations (Based on YOUR Location)', html);
                    
                    // Initialize chart after showing
                    setTimeout(() => {
                        showProfitChart();
                    }, 100);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult('Error', '<p>Failed to get recommendations</p>');
            }
            
            hideLoading();
        }
        
        async function getRealWeather() {
            try {
                const response = await fetch(`/api/weather?lat=${currentLocation.lat}&lon=${currentLocation.lon}`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <div class="weather-widget">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="weather-temp">${data.current_temp}¬∞C</div>
                                    <div>Wind: ${data.current_wind} km/h</div>
                                </div>
                                <div style="font-size: 4rem;">üå§Ô∏è</div>
                            </div>
                            <div class="weather-details">
                                <div>
                                    <div>Avg Temp</div>
                                    <div style="font-size: 1.3rem; font-weight: 600;">${data.avg_temp}¬∞C</div>
                                </div>
                                <div>
                                    <div>Rain (3-day)</div>
                                    <div style="font-size: 1.3rem; font-weight: 600;">${data.total_rain}mm</div>
                                </div>
                                <div>
                                    <div>Source</div>
                                    <div style="font-size: 0.8rem;">${data.source}</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px;">
                                <strong>üåæ Farming Advice:</strong> ${data.advice}
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px;">7-Day Forecast for Your Location</h3>
                        <div style="display: grid; grid-template-columns: repeat(7,1fr); gap: 5px;">
                    `;
                    
                    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    for (let i = 0; i < 7; i++) {
                        html += `
                            <div style="background: white; padding: 10px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                <div style="font-weight: 600;">${days[i]}</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #1e4a2b;">${Math.round(data.forecast.temperature_2m_max[i])}¬∞</div>
                                <div style="font-size: 0.9rem; color: #666;">${data.forecast.precipitation_sum[i]}mm</div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    document.getElementById('weatherContent').innerHTML = html;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function previewSoilImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function analyzeSoilImage() {
            const fileInput = document.getElementById('soilImage');
            if (!fileInput.files[0]) {
                alert('Please upload a soil image first');
                return;
            }
            
            showLoading();
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('lat', currentLocation.lat);
            formData.append('lon', currentLocation.lon);
            
            try {
                const response = await fetch('/api/analyze-soil-image', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    currentSoilPH = data.ph;
                    
                    let html = `
                        <div style="display: grid; grid-template-columns: repeat(2,1fr); gap: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                <h4 style="color: #1e4a2b;">Soil pH</h4>
                                <div style="font-size: 3rem; font-weight: 700; color: #1e4a2b;">${data.ph}</div>
                                <div>${data.classification}</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                <h4 style="color: #1e4a2b;">Nutrients</h4>
                                <div style="margin: 10px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Nitrogen (N):</span>
                                        <strong>${data.nitrogen}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Phosphorus (P):</span>
                                        <strong>${data.phosphorus}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Potassium (K):</span>
                                        <strong>${data.potassium}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #f0f7f0; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <h4 style="color: #1e4a2b;">üå± Recommendations</h4>
                            <p>${data.recommendation}</p>
                            <p><small>Source: ${data.source}</small></p>
                        </div>
                    `;
                    
                    showResult('ü™¥ Soil Analysis Report', html);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult('Error', '<p>Failed to analyze soil</p>');
            }
            
            hideLoading();
        }
        
        async function getMarketPrices() {
            const crop = document.getElementById('marketCrop').value;
            
            showLoading();
            
            try {
                const response = await fetch(`/api/market-prices?crop=${crop}`);
                const data = await response.json();
                
                if (data.success) {
                    let trendColor = data.trend === 'up' ? '#1e4a2b' : data.trend === 'down' ? '#c53030' : '#856404';
                    let trendBg = data.trend === 'up' ? '#e8f5e9' : data.trend === 'down' ? '#ffe5e5' : '#fff3cd';
                    
                    let html = `
                        <div style="display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin: 20px 0;">
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                <div style="color: #666;">Today</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1e4a2b;">‚Çπ${data.current}</div>
                                <div>/kg</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                <div style="color: #666;">Next Week</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1e4a2b;">‚Çπ${data.next_week}</div>
                                <div>/kg</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                                <div style="color: #666;">Next Month</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1e4a2b;">‚Çπ${data.next_month}</div>
                                <div>/kg</div>
                            </div>
                        </div>
                        
                        <div style="background: ${trendBg}; padding: 20px; border-radius: 12px;">
                            <h4 style="color: ${trendColor};">Market Advice</h4>
                            <p>${data.advice}</p>
                            <p><small>Source: ${data.source}</small></p>
                        </div>
                    `;
                    
                    document.getElementById('marketContent').innerHTML = html;
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            hideLoading();
        }
        
        async function getIntercropping(crop) {
            try {
                const response = await fetch(`/api/intercropping?crop=${crop}`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <div style="margin: 20px 0; padding: 15px; background: #e8f5e9; border-radius: 12px;">
                            <h4 style="color: #1e4a2b;">üå± Benefits of Intercropping</h4>
                            <p>‚úì Increases yield by 20-30%</p>
                            <p>‚úì Natural pest control</p>
                            <p>‚úì Improves soil health</p>
                            <p>‚úì Better use of land</p>
                        </div>
                        
                        <h4 style="color: #1e4a2b; margin: 20px 0 10px;">‚úÖ Good Companions for ${data.main_crop}</h4>
                    `;
                    
                    data.good.forEach(comp => {
                        const name = comp[`name_${currentLang}`] || comp.name;
                        html += `
                            <div class="companion-card">
                                <div class="companion-icon">${comp.icon}</div>
                                <div>
                                    <h4>${name}</h4>
                                    <p style="color: #1e4a2b;">${comp.benefit}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `<h4 style="color: #c53030; margin: 20px 0 10px;">‚ùå Avoid Planting With ${data.main_crop}</h4>`;
                    
                    data.bad.forEach(comp => {
                        const name = comp[`name_${currentLang}`] || comp.name;
                        html += `
                            <div class="companion-card bad-companion">
                                <div class="companion-icon">${comp.icon}</div>
                                <div>
                                    <h4>${name}</h4>
                                    <p style="color: #c53030;">${comp.reason}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('intercropContent').innerHTML = html;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function getSowingAdvice() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                let html = `
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h4 style="color: #1e4a2b;">üå± Sowing Instructions</h4>
                        <ul style="margin-left: 20px; margin-top: 15px; line-height: 1.8;">
                            <li>‚úì Prepare soil by plowing and adding compost</li>
                            <li>‚úì Sow seeds 2-3 cm deep</li>
                            <li>‚úì Maintain 30 cm spacing between plants</li>
                            <li>‚úì Water immediately after sowing</li>
                            <li>‚úì Add organic fertilizer before sowing</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f0f7f0; padding: 25px; border-radius: 15px;">
                        <h4 style="color: #1e4a2b;">üìÖ Best Sowing Time for Your Location</h4>
                        <p style="font-size: 2rem; font-weight: 700; color: #1e4a2b;">June 15 - July 15</p>
                        <p>Based on your location and current weather patterns</p>
                    </div>
                `;
                
                showResult('üåø Sowing Guide', html);
            }, 1000);
        }
        
        function getHarvestTime() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                let html = `
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="font-size: 5rem;">‚è∞</div>
                        <h3 style="color: #1e4a2b; margin: 20px 0;">Ready to Harvest in 15 Days</h3>
                        <p style="font-size: 1.2rem;">Expected Date: October 15, 2025</p>
                        <div style="margin-top: 20px; padding: 15px; background: #f0f7f0; border-radius: 12px; text-align: left;">
                            <h4 style="color: #1e4a2b;">Harvest Tips</h4>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>‚úì Harvest in morning for freshness</li>
                                <li>‚úì Use sharp tools to avoid damage</li>
                                <li>‚úì Keep harvested crop in shade</li>
                                <li>‚úì Sort and grade immediately</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                showResult('‚è∞ Harvest Timing', html);
            }, 1000);
        }
        
        function getStorageAdvice() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                let html = `
                    <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <h4 style="color: #1e4a2b;">üìã Storage Method</h4>
                        <p style="font-size: 1.2rem; margin-top: 10px;">Store in cool, dry place at 12-15¬∞C with 60-70% humidity</p>
                        <p style="margin-top: 10px;">‚úì Keep away from direct sunlight</p>
                        <p>‚úì Ensure proper ventilation</p>
                        <p>‚úì Check regularly for spoilage</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2,1fr); gap: 15px;">
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: #666;">Max Storage</div>
                            <div style="font-size: 2.5rem; font-weight: 700; color: #1e4a2b;">60 days</div>
                        </div>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="color: #856404;">Expected Loss</div>
                            <div style="font-size: 2.5rem; font-weight: 700;">5-8%</div>
                        </div>
                    </div>
                `;
                
                showResult('üì¶ Storage Advice', html);
            }, 1000);
        }
        
        // ============================================
        // CAMERA FUNCTIONS
        // ============================================
        
        let videoStream = null;
        
        async function startCamera() {
            const video = document.getElementById('video');
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = videoStream;
                video.style.display = 'block';
            } catch(err) {
                alert('Please allow camera access to use this feature');
            }
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                document.getElementById('video').style.display = 'none';
                videoStream = null;
            }
        }
        
        async function captureImage() {
            const video = document.getElementById('video');
            if (!video.srcObject) {
                alert('Please start camera first');
                return;
            }
            
            showLoading();
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('image', blob, 'crop.jpg');
                
                try {
                    const response = await fetch('/api/detect-disease', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        let html = `
                            <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <h3 style="color: #856404;">‚ö†Ô∏è ${result.disease}</h3>
                                <p><strong>Confidence:</strong> ${result.confidence}%</p>
                            </div>
                            
                            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #1e4a2b;">üîç Symptoms</h4>
                                <p>${result.symptoms}</p>
                            </div>
                            
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #1e4a2b;">üåø Organic Treatment</h4>
                                <p>${result.organic_treatment}</p>
                            </div>
                            
                            <div style="background: #f0f7f0; padding: 20px; border-radius: 12px;">
                                <h4 style="color: #1e4a2b;">‚öïÔ∏è Chemical Treatment</h4>
                                <p>${result.chemical_treatment}</p>
                            </div>
                        `;
                        
                        showResult('üî¨ Disease Detection Report', html);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showResult('Error', '<p>Failed to analyze image</p>');
                }
                hideLoading();
            }, 'image/jpeg');
        }
        
        // ============================================
        // CHATBOT FUNCTIONS
        // ============================================
        
        function toggleChatbot() {
            const chatbot = document.getElementById('chatbot');
            chatbot.style.display = chatbot.style.display === 'none' ? 'flex' : 'none';
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const messages = document.getElementById('chatMessages');
            messages.innerHTML += `<div class="user-message">${message}</div>`;
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, lang: currentLang })
                });
                const data = await response.json();
                
                setTimeout(() => {
                    messages.innerHTML += `<div class="bot-message">${data.reply}</div>`;
                    messages.scrollTop = messages.scrollHeight;
                }, 500);
            } catch (error) {
                messages.innerHTML += `<div class="bot-message">Sorry, I'm having trouble. Please try again.</div>`;
            }
        }
        
        // ============================================
        // BLOCKCHAIN FUNCTIONS
        // ============================================
        
        async function viewBlockchain() {
            showLoading();
            try {
                const response = await fetch('/api/blockchain');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load blockchain');
                }
                
                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1e4a2b; color: white; border-radius: 12px;">
                        <strong>üìä Blockchain Stats</strong>
                        <div style="display: flex; gap: 20px; margin-top: 10px;">
                            <div>Total Blocks: ${data.length}</div>
                            <div>Total Transactions: ${data.transactions.length}</div>
                        </div>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                `;
                
                data.chain.forEach((block, index) => {
                    const date = new Date(block.timestamp * 1000);const formattedDate = date.toLocaleString();
                    
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #1e4a2b; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="color: #1e4a2b; margin: 0;">Block #${block.index}</h4>
                                <span class="badge">${block.transactions.length} Transactions</span>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                ‚è∞ ${formattedDate}
                            </div>
                            <div style="background: #f8faf8; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 12px; color: #666; word-break: break-all;">
                                    <strong>Previous Hash:</strong> ${block.previous_hash.substring(0, 30)}...
                                </div>
                            </div>
                    `;
                    
                    if (block.transactions.length > 0) {
                        html += `<div style="margin-top: 10px;"><strong>üìù Transactions:</strong></div>`;
                        block.transactions.forEach((tx, txIndex) => {
                            const txDate = new Date(tx.timestamp * 1000).toLocaleString();
                            html += `
                                <div style="background: #f0f7f0; padding: 12px; border-radius: 8px; margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>üë®‚Äçüåæ ${tx.farmer}</span>
                                        <span>${tx.crop}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                        <span>üí∞ ‚Çπ${tx.price}/kg</span>
                                        <span>üì¶ ${tx.quantity} kg</span>
                                    </div>
                                    <div style="font-size: 10px; color: #666; margin-top: 5px;">
                                        üìç ${tx.location} ‚Ä¢ ${txDate}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += `<p style="color: #666; font-style: italic; margin-top: 10px;">No transactions in this block</p>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
                
                html += `
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-small" onclick="addTestTransaction()" style="flex: 1;">
                            ‚ûï Add Test Transaction
                        </button>
                    </div>
                `;
                
                showResult('üîó Blockchain Ledger', html);
            } catch (error) {
                console.error('Blockchain error:', error);
                showResult('Error', '<p>Failed to load blockchain</p>');
            }
            hideLoading();
        }
        
        async function viewTransactions() {
            showLoading();
            try {
                const response = await fetch('/api/blockchain/transactions');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load transactions');
                }
                
                if (data.transactions.length === 0) {
                    showResult('üìù Transactions', '<p style="text-align: center;">No transactions yet</p>');
                    hideLoading();
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #1e4a2b;">Total Transactions: ${data.count}</h4>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                `;
                
                data.transactions.reverse().forEach((tx, index) => {
                    const date = new Date(tx.timestamp * 1000).toLocaleString();
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #1e4a2b; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>#${data.transactions.length - index}</strong>
                                <span style="font-size: 12px; color: #666;">${date}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div>üë®‚Äçüåæ ${tx.farmer}</div>
                                <div>üåæ ${tx.crop}</div>
                                <div>üí∞ ‚Çπ${tx.price}/kg</div>
                                <div>üì¶ ${tx.quantity} kg</div>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                üìç ${tx.location}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                showResult('üìù All Transactions', html);
            } catch (error) {
                console.error('Error:', error);
                showResult('Error', '<p>Failed to load transactions</p>');
            }
            hideLoading();
        }
        
        async function addTestTransaction() {
            showLoading();
            
            const crops = ['Tomato', 'Onion', 'Potato', 'Brinjal', 'Chili'];
            const farmers = ['Ram', 'Shyam', 'Raju', 'Kisan Singh', 'Farmer Krish'];
            
            const transaction = {
                farmer: farmers[Math.floor(Math.random() * farmers.length)],
                crop: crops[Math.floor(Math.random() * crops.length)],
                price: Math.floor(Math.random() * 30) + 20,
                quantity: Math.floor(Math.random() * 500) + 100,
                location: `${currentLocation.lat.toFixed(4)},${currentLocation.lon.toFixed(4)}`
            };
            
            try {
                const response = await fetch('/api/add-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transaction)
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Transaction added to blockchain!', 'success');
                    viewBlockchain();
                } else {
                    showNotification('‚ùå Failed to add transaction', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error adding transaction', 'error');
            }
            hideLoading();
        }
        
        // ============================================
        // COMPARE FARMS
        // ============================================
        
        async function compareFarms() {
            showLoading();
            try {
                const response = await fetch(`/api/compare-farms?lat=${currentLocation.lat}&lon=${currentLocation.lon}`);
                const data = await response.json();
                
                let html = '<div style="display: grid; gap: 10px;">';
                data.farms.forEach(farm => {
                    const better = farm.yield > data.my_yield ? '‚¨ÜÔ∏è Higher' : '‚¨áÔ∏è Lower';
                    const betterClass = farm.yield > data.my_yield ? 'trend-up' : 'trend-down';
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div>
                                <strong>${farm.name}</strong>
                                <div style="display: flex; gap: 10px; margin-top: 5px;">
                                    <span>${farm.icon} ${farm.crop}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">${farm.yield} kg/acre</div>
                                <div style="color: #1e4a2b;">‚Çπ${farm.profit}</div>
                                <div style="font-size: 12px; color: ${farm.yield > data.my_yield ? '#1e4a2b' : '#c53030'};">
                                    ${better}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `
                    <div style="background: #1e4a2b; color: white; padding: 20px; border-radius: 12px; margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üåæ Your Farm</strong>
                                <div style="margin-top: 5px;">${document.getElementById('farmSize').value} acres</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${data.my_yield} kg/acre</div>
                                <div>‚Çπ${data.my_profit} profit</div>
                            </div>
                        </div>
                    </div>
                `;
                html += '</div>';
                
                showResult('üìä Farm Comparison with Neighbors', html);
            } catch (error) {
                console.error('Error:', error);
                showResult('Error', '<p>Failed to compare farms</p>');
            }
            hideLoading();
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function showProfitChart() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'],
                    datasets: [{
                        label: 'Projected Profit (‚Çπ)',
                        data: [150000, 220000, 310000, 450000, 680000],
                        borderColor: '#1e4a2b',
                        backgroundColor: 'rgba(30,74,43,0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value / 1000 + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function selectCrop(cropId) {
            showNotification(`‚úÖ ${cropId} selected! Check Sowing Guide for next steps.`, 'success');
        }
        
        function updateAll() {
            fetchWeatherAndSoil();
            loadStage(currentStage);
        }
        
        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultBox').classList.remove('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function showResult(title, content) {
            document.getElementById('resultTitle').innerHTML = title;
            document.getElementById('resultContent').innerHTML = content;
            document.getElementById('resultBox').classList.add('show');
        }
        
        // ============================================
        // RAIN ALERT
        // ============================================
        
        async function checkRainAlert() {
            try {
                const response = await fetch(`/api/rain-alert?lat=${currentLocation.lat}&lon=${currentLocation.lon}`);
                const data = await response.json();
                
                const alertDiv = document.getElementById('rainAlert');
                alertDiv.className = `rain-alert ${data.alert.toLowerCase()}`;
                alertDiv.innerHTML = data.message;
                alertDiv.style.display = 'block';
                
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 10000);
            } catch (error) {
                console.error('Rain alert error:', error);
            }
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            updateAllText();
            getUserLocation(); // Try to get GPS on load
            loadStage(1);
            
            // Check rain alert every 5 minutes
            checkRainAlert();
            setInterval(checkRainAlert, 300000);
        });
    </script>
</body>
</html>